ファイル管理
===============

ファイルを扱う際の最初の注意点は、ユーザーが動的関数に直接データを渡せないようにすることです。
PHP のような言語では、動的に include された関数にユーザーデータを渡すことは、深刻なセキュリティリスクとなりえます。Go はコンパイルされた言語ですので、`include` 関数は存在しません。
また、ライブラリは通常、動的にロードされません[^1]。

ファイルのアップロードは認証されたユーザーからしか許可されるべきではありません。
それを担保したうえで、許容されるファイルタイプのみがアップロードできるようにすること（ホワイトリスティング）も、セキュリティ上のもう一つの重要な観点です。
このチェックは、MIME タイプを検出する以下の Go 関数 `func DetectContentType(data []byte) string` を利用できます。

以下は、ファイルを読み込んでファイルタイプを計算する簡単なプログラム（[filetype.go][0]) の関連部分です。

```go
{...}
// Write our file to a buffer
// Why 512 bytes? See http://golang.org/pkg/net/http/#DetectContentType
buff := make([]byte, 512)

_, err = file.Read(buff)
{...}
//Result - Our detected filetype
filetype := http.DetectContentType(buff)
```

ファイルタイプを特定した後、許可されるファイルタイプのホワイトリストに照らし合わせます。
この例では、次のセクションで行います。

```go
{...}
switch filetype {
case "image/jpeg", "image/jpg":
  fmt.Println(filetype)
case "image/gif":
  fmt.Println(filetype)
case "image/png":
  fmt.Println(filetype)
default:
  fmt.Println("unknown file type uploaded")
}
{...}
```

ユーザーがアップロードしたファイルは、アプリケーションの Web コンテキストに保存されるべきではありません。
代わりに、ファイルはコンテンツサーバーやデータベースに保存されるべきです。
ファイルのアップロード先が実行権限を持たないように注意してください。

アップロード先のファイルサーバーが \*NIX 系の場合、chroot 環境や論理ドライブとしてマウントするなどの安全策を講じてください。

再びですが、Go はコンパイル言語であるため、アップロードされるファイルに悪意のあるコードが含まれていても実行されるリスクは、通常存在しません。

動的なリダイレクトを通してユーザーデータは渡されるべきではありません。もしそれが必要な場合、アプリケーションを安全に保つために追加の手順を踏まなければなりません。
このようなチェックには、適切に検証されたデータのみを受け入れることと、相対パス URL のチェックを含みます。

さらに、動的なリダイレクトでデータを渡す場合は、ディレクトリやファイルのパスがあらかじめ定義されたパスのリストのインデックスにマップされていることを確認し、そのインデックスを使用することが重要です。

ファイルの絶対パスはユーザーに送らず、常に相対パスを送ってください。

アプリケーションファイルやリソースに関するサーバーのパーミッションを読み取り専用にし、ファイルがアップロードされたら、ウィルスやマルウェアがないかスキャンしましょう。

[^1]:  Go 1.8 では、[新しいプラグイン機構]( https://golang.org/pkg/plugin/ ) を介して動的ロードができるようになりました。このメカニズムを使用するアプリケーションでは、ユーザーの入力に対して予防策を講じる必要があります。

[0]: ./filetype/filetype.go
